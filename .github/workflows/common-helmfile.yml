on:
  workflow_call:
    inputs:
      cluster:
        required: true
        type: string
      arguments:
        required: true
        type: string

permissions:
  contents: read
  security-events: write

jobs:
  run-helmfile:
    name: run-helmfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1 https://github.com/actions/checkout/releases/tag/v5.0.1

      - name: Install kubectl
        uses: azure/setup-kubectl@0c5e050edfed71b2b50731ab044d42489d51c129 # v4.0.0 https://github.com/Azure/setup-kubectl/releases/tag/vv4.0.0
        with:
          version: "v1.32.3"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          scan-type: 'fs'
          scan-ref: 'helmfile-app'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@b8d3b6e
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Sops Binary Installer
        uses: mdgreenwald/mozilla-sops-action@d9714e521cbaecdae64a89d2fdd576dd2aa97056 # v1.6.0 https://github.com/mdgreenwald/mozilla-sops-action/releases/tag/v1.6.0

      - name: Setup AWS Profile
        if: inputs.cluster == 'aws-vpn'
        run: |
          mkdir -p ~/.aws
          cat > ~/.aws/credentials << EOF
          [vpn_aws]
          aws_access_key_id = ${{ secrets.VPN_OPS_AWS_ACCESS_KEY_ID }}
          aws_secret_access_key = ${{ secrets.VPN_OPS_AWS_SECRET_ACCESS_KEY }}
          EOF

          cat > ~/.aws/config << EOF
          [profile vpn_aws]
          region = us-east-1
          EOF

          echo "AWS_PROFILE=vpn_aws" >> $GITHUB_ENV

      - name: Install AWS CLI
        if: inputs.cluster == 'aws-vpn'
        run: |
          set -e
          # Bail if AWS CLI is already in PATH
          export PATH=$HOME/bin:$PATH
          if which aws >/dev/null; then
            if test -f $HOME/bin/aws; then
              echo $HOME/bin >> $GITHUB_PATH
            fi
            exit 0
          fi
          curl "https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m).zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          cd aws && ./install -i $HOME/aws-cli -b $HOME/bin --update
          rm -rf aws awscliv2.zip
          echo $HOME/bin >> $GITHUB_PATH

      - name: Configure EKS access
        if: inputs.cluster == 'aws-vpn'
        run: aws --region us-east-1 eks update-kubeconfig --name vpn-us-east-1

      - name: Run Helmfile
        uses: helmfile/helmfile-action@6f21d94fa797f5dfbc92b9db62c6832ac6639a88 # v2.0.5 https://github.com/helmfile/helmfile-action/releases/tag/v2.0.5
        with:
          helmfile-version: "v1.1.5"
          helm-version: "v3.19.0"
          helm-plugins: >
            https://github.com/databus23/helm-diff,
            https://github.com/jkroepke/helm-secrets
          helmfile-workdirectory: helmfile-app
          helmfile-args: "-e ${{ inputs.cluster }} ${{ inputs.arguments }}"
          helmfile-auto-init: "false"
