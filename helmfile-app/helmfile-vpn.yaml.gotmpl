---
bases:
  - helmfile-defaults.yaml.gotmpl
  - helmfile-repos.yaml

---
releases:
  - name: eks
    namespace: kube-system
    chart: eks/aws-load-balancer-controller
    version: 1.13.0
    labels:
      app: eks-lb
    condition: eks_lb.enabled
    hooks:
    - events: ["presync"]
      showlogs: true
      command: kubectl
      args:
        [
          "apply",
          "-f",
          "https://raw.githubusercontent.com/aws/eks-charts/master/stable/aws-load-balancer-controller/crds/crds.yaml"
        ]
    values:
      - eks-lb/values.yaml.gotmpl

  - name: grafana-alloy
    namespace: alloy
    chart: grafana/alloy
    version: 1.1.0
    labels:
      app: grafana-alloy
    condition: grafana.enabled
    values:
      - grafana-alloy/values.yaml.gotmpl

  - name: kube-state-metrics
    namespace: kube-system
    chart: prometheus-community/kube-state-metrics
    version: 6.1.0
    labels:
      app: kube-state-metrics
    condition: kube-state-metrics.enabled
    values:
      - kube-state-metrics/values.yaml

  - name: storageclasses
    namespace: kube-system
    chart: oci://ghcr.io/blinklabs-io/helm-charts/charts/storageclasses
    version: 0.1.1
    labels:
      app: storageclasses
    values:
      - storageclasses: {{ toYaml .Values.storageclasses | nindent 10 }}

  {{- range $key, $values := .Values.vpn.instances }}
  {{-   $mergedValues := (mustMerge $values $.Values.vpn.defaults (dict "key" $key)) }}
  - name: vpn-indexer
    namespace: vpn-{{ $key }}
    chart: oci://ghcr.io/blinklabs-io/helm-charts/charts/vpn-indexer
    version: 0.5.5
    labels:
      app: vpn-{{ $key }}
      protocol: openvpn
    condition: vpn.enabled
    values:
      - vpn/values.indexer.yaml.gotmpl
      - {{- tpl (readFile "vpn/templates/vpn-indexer.yaml.gotmpl") $mergedValues | nindent 8 }}

  - name: vpn-{{ $key }}
    namespace: vpn-{{ $key }}
    chart: oci://ghcr.io/blinklabs-io/helm-charts/charts/openvpn
    version: 0.9.0
    labels:
      app: vpn-{{ $key }}
      protocol: openvpn
    condition: vpn.enabled
    values:
      - vpn/values.instance.yaml
      - {{- tpl (readFile "vpn/templates/vpn-instance.yaml.gotmpl") $mergedValues | nindent 8 }}
  {{- end }}

  # WireGuard releases
  {{- range $key, $values := .Values.wireguard.instances }}
  {{-   $wgDefaults := $.Values.wireguard.defaults }}
  {{-   $mergedValues := (mustMerge $values $wgDefaults (dict "key" $key)) }}
  - name: wg-indexer-{{ $key }}
    namespace: wg-{{ $key }}
    chart: oci://ghcr.io/blinklabs-io/helm-charts/charts/vpn-indexer
    version: 0.5.5
    labels:
      app: wg-{{ $key }}
      protocol: wireguard
    condition: wireguard.enabled
    values:
      - vpn/values.indexer.yaml.gotmpl
      - {{- tpl (readFile "wireguard/templates/wg-indexer.yaml.gotmpl") $mergedValues | nindent 8 }}

  - name: wg-{{ $key }}
    namespace: wg-{{ $key }}
    chart: oci://ghcr.io/blinklabs-io/helm-charts/charts/wireguard
    version: {{ $mergedValues.chartVersion | default "0.1.0" }}
    labels:
      app: wg-{{ $key }}
      protocol: wireguard
    condition: wireguard.enabled
    values:
      - wireguard/values.yaml.gotmpl
      - {{- tpl (readFile "wireguard/templates/wg-instance.yaml.gotmpl") $mergedValues | nindent 8 }}
  {{- end }}
